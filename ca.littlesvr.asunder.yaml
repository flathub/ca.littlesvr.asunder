app-id: ca.littlesvr.asunder
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: "19.08"
command: asunder

rename-desktop-file: asunder.desktop
rename-icon: asunder

finish-args:
- --socket=wayland
- --socket=fallback-x11
- --socket=x11
- --share=ipc

# Required for CD drive access
# https://github.com/flatpak/flatpak/issues/12
- --device=all

# Required to load music metadata
- --share=network

# Required for input-output
- --filesystem=xdg-download
- --filesystem=xdg-music
- --env=TMPDIR=/var/tmp

cleanup:
- /man
- /include
- /share/man
- /share/doc
- /lib/*.a
- /lib/*.la

modules:

- shared-modules/gtk2/gtk2.json

- name: fdkaac
  buildsystem: autotools
  config-opts:
    - --prefix=/app
  sources:
    - type: archive
      url: https://github.com/mstorsjo/fdk-aac/archive/v2.0.1.tar.gz
      sha256: a4142815d8d52d0e798212a5adea54ecf42bcd4eec8092b37a8cb615ace91dc6

- name: flac
  buildsystem: autotools
  config-opts:
    - -disable-xmms-plugin
  sources:
    - type: archive
      url: http://deb.debian.org/debian/pool/main/f/flac/flac_1.3.3.orig.tar.xz
      sha256: 213e82bd716c9de6db2f98bcadbc4c24c7e2efe8c75939a1a84e28539c4e1748
  cleanup:
    - /share/aclocal

# required by lame encoders ¯\_(ツ)_/¯
- name: libncurses
  buildsystem: autotools
  config-opts:
    - --without-ada
    - --without-tests
    - --without-progs
    - --without-sysmouse
    - --disable-termcap
  sources:
  - type: archive
    url: http://ftp.gnu.org/gnu/ncurses/ncurses-6.1.tar.gz
    sha256: aa057eeeb4a14d470101eff4597d5833dcef5965331be3528c08d99cebaa0d17
  cleanup:
    - /bin/ncurses6-config

# Lame 3.99.5 is in the shared modules, but this is newer
- name: lame
  buildsystem: autotools
  config-opts:
    - --enable-nasm
    - --with-fileio=sndfile
    - --disable-static
  sources:
    - type:   archive
      url:    http://deb.debian.org/debian/pool/main/l/lame/lame_3.100.orig.tar.gz
      sha256: ddfe36cab873794038ae2c1210557ad34857a4b6bdc515785d1da9e175b1da1e

# The config.quess patches are required because the latest version of the
# vorbis-tools is from 2008, long before aarch64 existed.
# https://github.com/xiph/vorbis-tools/issues/22
- name: vorbis-tools
  buildsystem: autotools
  sources:
    - type:   archive
      url:    http://deb.debian.org/debian/pool/main/v/vorbis-tools/vorbis-tools_1.4.0.orig.tar.gz
      sha256: a389395baa43f8e5a796c99daf62397e435a7e73531c9f44d9084055a05d22bc
    - type:   file
      path:   ./vorbis-patches/config.guess
    - type:   file
      path:   ./vorbis-patches/config.sub
  cleanup:
    - /bin/vorbiscomment
    - /bin/ogginfo
    - /bin/oggdec
    - /bin/vcut
    - /share/locale
    - /share/runtime

- name: opus-tools
  buildsystem: autotools
  sources:
    - type:   archive
      url:    http://deb.debian.org/debian/pool/main/o/opus-tools/opus-tools_0.1.10.orig.tar.gz
      sha256: 2400c3434ec923cea100043f86bc4181997377c6105c697195779391cc5e70c4
  cleanup:
    - /bin/opusinfo
    - /bin/opusdec

- name: wavpack
  buildsystem: autotools
  sources:
    - type:   archive
      url:    http://deb.debian.org/debian/pool/main/w/wavpack/wavpack_5.1.0.orig.tar.bz2
      sha256: 1939627d5358d1da62bc6158d63f7ed12905552f3a799c799ee90296a7612944
  cleanup:
    - /bin/wvtag

# Instruction taken from org.freac.freac.json
- name: musepack
  sources:
    - type: archive
      url: https://files.musepack.net/source/musepack_src_r475.tar.gz
      sha256: a4b1742f997f83e1056142d556a8c20845ba764b70365ff9ccf2e3f81c427b2b
    - type: shell
      commands: 
        - touch include/config.h.in
        - head -n 34 configure.in >> configure.ac
        - echo "AM_CONDITIONAL([HAVE_VISIBILITY], [false])" >> configure.ac
        - echo "AC_CHECK_LIB([m],[cos])" >> configure.ac
        - tail -n 18 configure.in >> configure.ac
        - rm configure.in
        - autoreconf -i

- name: mac
  buildsystem: autotools
  sources:
    - type:   archive
      url:    https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/opensourceliving/mac-4.11-u4-b5-s7.tar.gz
      sha256: 174cce02a2e122fc69cb6c72d13371c400c6f9427219ebbd4d5beff1d11cd4f6
    - type:   patch
      path:   ./mac-patches/01_output.patch
    - type:   patch
      path:   ./mac-patches/02_exec-stack.diff
    - type:   patch
      path:   ./mac-patches/03_GCC-6.diff

- name: libcddb
  buildsystem: autotools
  sources:
    - type: archive
      url: http://prdownloads.sourceforge.net/libcddb/libcddb-1.3.2.tar.bz2
      sha256: 35ce0ee1741ea38def304ddfe84a958901413aa829698357f0bee5bb8f0a223b
      
- name: cdparanoia
  buildsystem: simple
  build-commands:
    - ./configure --prefix=/app
    - make all slib
    - make install
  sources:
    - type: archive
      url: http://downloads.xiph.org/releases/cdparanoia/cdparanoia-III-10.2.src.tgz
      sha256: 005db45ef4ee017f5c32ec124f913a0546e77014266c6a1c50df902a55fe64df

- name: asunder
  buildsystem: autotools
  config-opts:
    - --prefix=/app
  sources:
    - type: archive
      url: http://littlesvr.ca/asunder/releases/asunder-2.9.5.tar.bz2
      sha256: 64ce1159e237ec5fa785fe1e98f4e176f27e3b043f1ed0a058948f2cbe323d19
  post-install:
    - install -Dm 644 ./asunder.desktop -t /app/share/applications/
    - install -Dm 644 ./pixmaps/asunder.png -t /app/share/icons/hicolor/128x128/apps/

# Feature request has been made upstream to provide these files in the source package
# https://littlesvr.ca/bugs/show_bug.cgi?id=64
- name: metadata
  buildsystem: simple
  build-commands:
    - install -Dm 644 ca.littlesvr.asunder.metainfo.xml -t /app/share/metainfo/
    - install -Dm 644 asunder.svg /app/share/icons/scalable/apps/asunder.svg
  sources:
    - type: file
      path: ca.littlesvr.asunder.metainfo.xml
    - type: file
      path: asunder.svg

